---
name: Bump on release

on:
  repository_dispatch:
    types: [bump]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest

    env:
      FORMULA: ${{ github.event.client_payload.formula }}

    steps:

      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.HOMEBREW_APP_ID }}
          private-key: ${{ secrets.HOMEBREW_APP_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Check formula ${{ env.FORMULA }} exists
        run: |
          if [ ! -f "Formula/$FORMULA.rb" ]; then
            echo "Formula $FORMULA not found in tap. Exiting."
            exit 1
          fi

      - name: Install dependencies for ${{ env.FORMULA }}
        run: |
          brew deps --include-build --include-test "$FORMULA" | xargs brew install
        env:
          HOMEBREW_NO_ENV_HINTS: 1

      - name: Bump packages
        uses: Homebrew/actions/bump-packages@main
        with:
          # Custom GitHub access token with only the 'public_repo' scope enabled
          token: ${{ steps.app-token.outputs.token }}
          formulae: ${{ env.FORMULA }}
          fork: false
